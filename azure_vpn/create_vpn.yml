---
# need to prepare ansible to work with azure
# https://medium.com/@pavithra_38952/building-infrastructure-with-microsoft-azure-and-ansible-e5245e5b33a8


---
- name: Create VPN within Azure
 # hosts: all       # DONT THINK NEED
  connection: local
  tasks:
  # 1. Create a Resource Group - Container in a geographical location that holds everything
  - name: Create resource group
    azure_rm_resourcegroup:
      name: "{{ rg_name }}"
      location: "{{ az_region }}"
      state: present

  # 2. Create a virtual network (supernet) that holds all subnets
  - name: Create Virtual Network
    azure_rm_virtualnetwork:
      name: "{{ vn_name }}"
      resource_group: "{{ rg_name} }"
      address_prefixes_cidr: "{{ vn_pfx }}"
      state: present 

  # 3. Create subnet (interesting traffic) and gateway subnet (p-t-p link VPN gateway >to> Virtual Network) 
  - name: Create subnets
    azure_rm_subnet:
      name: "{{ item.key }}"
      virtual_network_name: 
      resource_group: "{{ rg_name }}"
      address_prefix_cidr: "{{ item.value }}"
      state: present 
    loop: "{{ subnets|dictitems }}"     



  # 4. Create the local network gateway - stores the VPN peer IP and the interesting traffic at the remote site


  # 5. Request a Public IP address
#  - name: Create Public IP address
#    azure_rm_publicipaddress:
#      resource_group: example
#      name: pip01
#      allocation_method: Static
#      domain_name: test 
#      state: present 
#    register: publicip 
#    tag: 
#      - recipe3

  # Display  Public IP address
#  - name: Show Public IP address
#    debug:  
#      msg: "{{ publicip.ip_address }}" 
#    tag: 
#      - recipe3



#6. Create the VPN gateway - Links public IP and GatewaySubnet 